//ç»™ä½ ä¸€ä¸ªä¸‹æ ‡ä» 0 å¼€å§‹çš„æ•´æ•°æ•°ç»„ nums ã€‚
//
// å®šä¹‰ nums ä¸€ä¸ªå­æ•°ç»„çš„ ä¸åŒè®¡æ•° å€¼å¦‚ä¸‹ï¼š
//
//
// ä»¤ nums[i..j] è¡¨ç¤º nums ä¸­æ‰€æœ‰ä¸‹æ ‡åœ¨ i åˆ° j èŒƒå›´å†…çš„å…ƒç´ æ„æˆçš„å­æ•°ç»„ï¼ˆæ»¡è¶³ 0 <= i <= j < nums.length ï¼‰
//ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§°å­æ•°ç»„ nums[i..j] ä¸­ä¸åŒå€¼çš„æ•°ç›®ä¸º nums[i..j] çš„ä¸åŒè®¡æ•°ã€‚
//
//
// è¯·ä½ è¿”å› nums ä¸­æ‰€æœ‰å­æ•°ç»„çš„ ä¸åŒè®¡æ•° çš„ å¹³æ–¹ å’Œã€‚
//
// ç”±äºç­”æ¡ˆå¯èƒ½ä¼šå¾ˆå¤§ï¼Œè¯·ä½ å°†å®ƒå¯¹ 10â¹ + 7 å–ä½™ åè¿”å›ã€‚
//
// å­æ•°ç»„æŒ‡çš„æ˜¯ä¸€ä¸ªæ•°ç»„é‡Œé¢ä¸€æ®µè¿ç»­ éç©º çš„å…ƒç´ åºåˆ—ã€‚
//
//
//
// ç¤ºä¾‹ 1ï¼š
//
//
//è¾“å…¥ï¼šnums = [1,2,1]
//è¾“å‡ºï¼š15
//è§£é‡Šï¼šå…­ä¸ªå­æ•°ç»„åˆ†åˆ«ä¸ºï¼š
//[1]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
//[2]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
//[1]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
//[1,2]: 2 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
//[2,1]: 2 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
//[1,2,1]: 2 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
//æ‰€æœ‰ä¸åŒè®¡æ•°çš„å¹³æ–¹å’Œä¸º 1Â² + 1Â² + 1Â² + 2Â² + 2Â² + 2Â² = 15 ã€‚
//
//
// ç¤ºä¾‹ 2ï¼š
//
//
//è¾“å…¥ï¼šnums = [2,2]
//è¾“å‡ºï¼š3
//è§£é‡Šï¼šä¸‰ä¸ªå­æ•°ç»„åˆ†åˆ«ä¸ºï¼š
//[2]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
//[2]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
//[2,2]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
//æ‰€æœ‰ä¸åŒè®¡æ•°çš„å¹³æ–¹å’Œä¸º 1Â² + 1Â² + 1Â² = 3 ã€‚
//
//
//
//
// æç¤ºï¼š
//
//
// 1 <= nums.length <= 10âµ
// 1 <= nums[i] <= 10âµ
//
//
// Related Topics æ ‘çŠ¶æ•°ç»„ çº¿æ®µæ ‘ æ•°ç»„ åŠ¨æ€è§„åˆ’ ğŸ‘ 18 ğŸ‘ 0

package main

import (
	"fmt"
	"math/bits"
)

func main() {
	nums := []int{1, 2, 1}
	//nums = []int{2, 2}
	//nums = []int{1}
	counts := sumCounts(nums)
	fmt.Println(counts)

	//for i, v := range nums {
	//	i++
	//	fmt.Println(i, v)
	//}
}

// leetcode submit region begin(Prohibit modification and deletion)
func sumCounts(nums []int) int {
	// å‚è€ƒï¼šlc-2262
	// é‡ç‚¹ï¼šå¢é‡çš„è®¡ç®—
	// æ¯”å¦‚ä½ç½® x+1 å¯¹ x çš„å¢é‡ï¼š(x+1)^2 - x^2 = 2*x + 1
	// æ‰€ä»¥ last = j æ—¶ï¼Œå¢é‡ä¸ºï¼šå¦‚ [1 2 2 3 1]ï¼Œj=0ï¼Œi=4
	// (v1 + v2 + v3) * 2 + i-j = (2+2+1)*2 + 4-0
	// åˆ™é‡‡ç”¨ çº¿æ®µæ ‘+æ‡’åŠ è½½ å®ç°å¢é‡çš„è®¡ç®—

	const mod = 1_000_000_007
	ret, s, n := 0, 0, len(nums)
	k := bits.Len(uint(n - 1))
	stLen := 1 << (k + 1)
	if n > 1 {
		stLen -= 1<<(k-bits.Len(uint(n-stLen>>2))+1) - 2
	}
	st := make([][2]int, stLen) // æ‡’æƒ°æ ‡è®°ï¼šå’Œã€å¢é‡ï¼Œç´¢å¼•ä» 1 å¼€å§‹
	last := make(map[int]int)
	down := func(l, r, i, d int) { // lazy æ›´æ–°
		st[i][0] += d * (r - l + 1) // æ›´æ–°åŒºé—´å’Œ
		st[i][1] += d               // æ›´æ–°å¢é‡
	}
	var rangeSumSegmentTree func(f, t, l, r, i, d int) int
	rangeSumSegmentTree = func(f, t, l, r, i, d int) int { // d ä¸ºå¢é‡
		var cur int
		if f <= l && r <= t {
			cur = st[i][0]   // é”™è¯¯ç‚¹ï¼šå¢é‡ d æ˜¯æ›´æ–° çº¿æ®µæ ‘ åï¼Œç”¨äºâ€œä¸‹ä¸€æ¬¡â€çš„è®¡ç®—
			down(l, r, i, d) // å…ˆä¿å­˜ st[i][0]ï¼Œå† down
			return cur
		}
		m, idx := (l+r)>>1, i<<1
		if ad := st[i][1]; ad != 0 { // æ›´æ–°æ‡’æƒ°æ ‡è®°
			down(l, m, idx, ad)
			down(m+1, r, idx+1, ad)
			st[i][1] = 0 // æ¸…é™¤æ‡’æƒ°æ ‡è®°
		}
		if f <= m {
			cur = rangeSumSegmentTree(f, t, l, m, idx, 1)
		}
		if t > m {
			cur += rangeSumSegmentTree(f, t, m+1, r, idx+1, 1)
		}
		st[i][0] = st[idx][0] + st[idx+1][0] // åŒºé—´å’Œ
		return cur
	}
	for i, v := range nums {
		l, t := last[v], i+1                                    // æ›´æ–°åŒºé—´ [l+1,t]
		s += rangeSumSegmentTree(l+1, t, 1, n, 1, 1)<<1 + t - l // é‡ç‚¹ï¼šæ‡’æƒ°æ ‡è®°åŒºé—´ [1,n]ï¼Œ4ä¸ªç´¢å¼•éƒ½ä» 0 / 1 å¼€å§‹å‡å¯
		//s += rangeSumSegmentTree(l, t-1, 0, n-1, 1, 1)<<1 + t - l
		ret = (ret + s) % mod
		last[v] = t // é»˜è®¤ç´¢å¼•ç”± 0 æ”¹ä¸ºä» 1 å¼€å§‹ï¼Œä¸” çº¿æ®µæ ‘ ä¹Ÿæ˜¯ä» 1 å¼€å§‹
	}
	return ret
}

//leetcode submit region end(Prohibit modification and deletion)
